@page "/"

@using CryptoList.ViewModel
@using CryptoList.Components;
@using CryptoList.Models
@using CryptoList.Services
@using System.ComponentModel
@implements IDisposable;
@inject FavoritesViewModel FavoritesViewModel;

<PageTitle>Coin overview</PageTitle>

<h1 class="title">
    Overview
</h1>

<p class="text-lg">
    Here you can find an overview of all available cryptocurrencies, star a coin to save it to your favorite coins.
</p>

<div class="coin-grid mt-10">
    @foreach (var coin in _coins)
    {
        <CoinCard 
            Coin="coin" 
            OnFavoriteClick="ToggleFavorite"
            Favorites="FavoritesViewModel.FavoriteCoins"
        />
    }
</div>

@code {
    private List<Coin> _coins = new();
    
    protected override async Task OnInitializedAsync()
    {
        FetchCoinsService.UpdateEvent += async coins => await InvokeAsync(() =>
        {
            _coins = coins;
            StateHasChanged();
        });

        FavoritesViewModel.PropertyChanged += OnPropertyChangedEventHandler!;

        await base.OnInitializedAsync();
    }

    void ToggleFavorite(string id)
    {
        FavoritesViewModel.ToggleFavorite(id);
    }

    async void OnPropertyChangedEventHandler(object sender, PropertyChangedEventArgs e)
    {
        await InvokeAsync(StateHasChanged);
    }

    public void Dispose()
    {
        FavoritesViewModel.PropertyChanged -= OnPropertyChangedEventHandler!;
    }
}